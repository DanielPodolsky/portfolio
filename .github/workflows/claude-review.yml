  name: Claude Code Review

  on:
    pull_request:
      types: [opened, synchronize, reopened]
    issue_comment:
      types: [created]

  permissions:
    contents: read
    pull-requests: write
    issues: write
    id-token: write

  jobs:
    claude-review:
      runs-on: ubuntu-latest
      if: |
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' &&
         github.event.issue.pull_request &&
         contains(github.event.comment.body, '@claude'))
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Claude Code Action
          uses: anthropics/claude-code-action@v1
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}           
            anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
            prompt: |
              REPO: ${{ github.repository }}
              PR NUMBER: ${{ github.event.pull_request.number }}

              Review this PR thoroughly. Check for:
              - Code quality and best practices
              - Potential bugs or issues
              - Security implications
              - Performance considerations

              Use `gh pr comment` for top-level feedback.
              Only post GitHub comments - don't submit review text as messages.

            claude_args: |
              --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
